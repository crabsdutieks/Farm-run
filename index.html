<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farm Runner: FIXED CLICK</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@800;900&display=swap');
        
        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }
        body { margin: 0; overflow: hidden; background: #48dbfb; font-family: 'Nunito', sans-serif; }
        canvas { display: block; width: 100%; height: 100%; position: fixed; top: 0; left: 0; z-index: 1; }

        /* --- UI LAYER (Le container global ne bloque pas les clics) --- */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 20; pointer-events: none; 
        }

        /* --- Ã‰CRANS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s;
            /* Fond semi-transparent pour bien voir le texte */
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            pointer-events: auto; /* L'Ã©cran capte les clics */
        }
        
        .hidden { opacity: 0 !important; pointer-events: none !important; }

        /* --- TITRE --- */
        h1 {
            font-size: 15vw; color: #fff; margin: 0 0 20px 0;
            text-shadow: 0 8px 0 #e67e22, 0 20px 20px rgba(0,0,0,0.5);
            transform: rotate(-3deg); animation: float 3s infinite ease-in-out;
            text-align: center; line-height: 0.9;
        }
        @media (min-width: 600px) { h1 { font-size: 80px; } }
        @keyframes float { 50% { transform: rotate(-3deg) translateY(-15px); } }

        /* --- PANNEAU CENTRAL --- */
        .card-panel {
            background: white; width: 90%; max-width: 380px; border-radius: 30px;
            padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 15px;
            transform: scale(1); transition: 0.3s;
        }

        /* --- QUETE --- */
        .quest-box { background: #f1f2f6; padding: 12px; border-radius: 15px; border: 2px solid #dfe4ea; }
        .quest-head { font-size: 11px; font-weight: 900; color: #a4b0be; letter-spacing: 1px; text-transform: uppercase; }
        .quest-txt { font-size: 14px; font-weight: 900; color: #2f3542; margin-top: 5px; display: flex; justify-content: space-between; }
        .quest-bar { height: 10px; background: #dfe4ea; border-radius: 5px; margin-top: 8px; overflow: hidden; }
        .quest-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.5s; }

        /* --- SHOP --- */
        .shop-title { font-size: 11px; font-weight: 900; color: #a4b0be; text-align: center; margin-top: 5px; }
        .shop-box { display: flex; gap: 10px; justify-content: center; margin-top: 5px; }
        .char-item {
            width: 70px; height: 90px; background: #f8f9fa; border: 3px solid #eee; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 35px; position: relative; cursor: pointer; transition: 0.2s;
            pointer-events: auto; /* Important pour le clic */
        }
        .char-item.selected { background: #fff; border-color: #f1c40f; transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 2; }
        .char-item.locked { filter: grayscale(1); opacity: 0.6; }
        .price { font-size: 10px; background: #2d3436; color: #f1c40f; padding: 2px 6px; border-radius: 5px; position: absolute; bottom: 5px; font-weight: bold; }
        .char-item.selected .price { display: none; }

        /* --- BOUTON JOUER (FIXÃ‰) --- */
        .btn-play {
            background: linear-gradient(to bottom, #f1c40f, #e67e22); 
            border: none; border-bottom: 6px solid #d35400;
            color: white; font-size: 28px; padding: 15px; border-radius: 50px; width: 100%;
            font-family: inherit; font-weight: 900; cursor: pointer; 
            text-shadow: 0 2px 0 rgba(0,0,0,0.2);
            margin-top: 10px;
            pointer-events: auto !important; /* FORCE LE CLIC */
            position: relative; z-index: 100; /* AU DESSUS DE TOUT */
        }
        .btn-play:active { transform: translateY(4px); border-bottom-width: 2px; }

        /* --- HUD & OVER --- */
        .hud-bar { position: absolute; top: 15px; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; pointer-events: none; }
        .pill { background: white; padding: 8px 20px; border-radius: 30px; font-weight: 900; color: #333; border: 3px solid #333; box-shadow: 0 5px 0 rgba(0,0,0,0.1); font-size: 18px; }

        #over-screen { background: rgba(235, 77, 75, 0.95); z-index: 30; }
        .score-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px; text-align: center; color: white; margin-bottom: 20px; width: 80%; }

        /* --- TUTO --- */
        #tuto { background: rgba(0,0,0,0.5); pointer-events: none; }
        .hand { font-size: 60px; animation: swipe 1.5s infinite; }
        @keyframes swipe { 0%,100%{transform:translateX(0);} 50%{transform:translateX(-40px) rotate(-10deg);} }
        
        #toast { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: #333; color: #f1c40f; padding: 10px 20px; border-radius: 30px; font-weight: 900; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; }
        .show-toast { opacity: 1 !important; transform: translate(-50%, 10px) !important; }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="ui-layer">
        <div id="menu" class="screen">
            <h1>FARM<br>RUNNER</h1>
            
            <div class="card-panel">
                <div class="quest-box">
                    <div class="quest-head">MISSION DU JOUR</div>
                    <div class="quest-txt">
                        <span id="q-desc">Chargement...</span>
                        <span style="color:#27ae60">+100ðŸ’°</span>
                    </div>
                    <div class="quest-bar"><div class="quest-fill" id="q-bar"></div></div>
                </div>

                <div>
                    <div class="shop-title">CHOISIS TON COUREUR</div>
                    <div class="shop-box" id="shop-list"></div>
                </div>

                <button id="btn-start" class="btn-play">JOUER</button>
                
                <div style="text-align:center; font-weight:900; color:#2d3436; font-size:14px;">SOLDE: <span id="menu-coins">0</span>ðŸ’°</div>
            </div>
        </div>

        <div id="hud" class="hidden">
            <div class="hud-bar">
                <div class="pill">SCORE <span id="score">0</span></div>
                <div class="pill" style="color:#f1c40f; border-color:#f1c40f">ðŸ’° <span id="coins">0</span></div>
            </div>
        </div>

        <div id="tuto" class="screen hidden">
            <div class="hand">ðŸ‘†</div>
            <div style="color:white; font-size:30px; font-weight:900; margin-top:20px; text-shadow:0 2px 0 #000;">GLISSE !</div>
        </div>

        <div id="over" class="screen hidden">
            <h1 style="font-size:60px; transform:rotate(0);">CRASH!</h1>
            <div class="score-card">
                <div style="font-size:14px; opacity:0.8">SCORE</div>
                <div style="font-size:50px; font-weight:900" id="end-score">0</div>
                <div style="margin-top:10px;">+<span id="end-coins">0</span>ðŸ’°</div>
            </div>
            <button class="btn-play" onclick="App.menu()">MENU</button>
        </div>

        <div id="toast">SUCCÃˆS !</div>
    </div>

    <script>
        /* --- 1. DATA & SAVE --- */
        const C = {
            chars: [
                { id:'c1', icon:'ðŸ”', price:0, col:0xffffff },
                { id:'c2', icon:'ðŸ°', price:100, col:0xb2bec3 },
                { id:'c3', icon:'ðŸ·', price:300, col:0xffcccc }
            ],
            quest: { desc:"Ramasser 20 piÃ¨ces", target:20 }
        };

        const Save = {
            data: { coins:0, unlock:['c1'], sel:'c1', qVal:0, qDone:false },
            load() {
                try {
                    const d = localStorage.getItem('FR_Fixed_Click');
                    if(d) this.data = {...this.data, ...JSON.parse(d)};
                } catch(e){}
            },
            save() { localStorage.setItem('FR_Fixed_Click', JSON.stringify(this.data)); },
            updateQuest(val) {
                if(this.data.qDone) return;
                this.data.qVal += val;
                if(this.data.qVal >= C.quest.target) {
                    this.data.qDone = true; this.data.coins += 100;
                    UI.toast("QUÃŠTE FINIE !");
                }
                this.save();
            }
        };

        /* --- 2. AUDIO --- */
        const Sfx = {
            ctx: null,
            init() { 
                if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)();
                if(this.ctx.state==='suspended') this.ctx.resume();
            },
            play(f,t,d) {
                if(!this.ctx) return;
                const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.type=t; o.frequency.value=f; g.gain.value=0.1;
                g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime+d);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d);
            },
            jump:()=>Sfx.play(300,'triangle',0.1), coin:()=>Sfx.play(1200,'square',0.1), crash:()=>Sfx.play(100,'sawtooth',0.4), buy:()=>Sfx.play(600,'sine',0.2)
        };

        /* --- 3. ENGINE --- */
        const Game = {
            scene:null, cam:null, ren:null, player:null,
            active:false, speed:0, score:0, coins:0, lane:0, tx:0,
            objs:[],

            init() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.Fog(0x87CEEB, 15, 50);

                this.cam = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
                this.ren = new THREE.WebGLRenderer({antialias:true});
                this.ren.setSize(window.innerWidth, window.innerHeight);
                this.ren.shadowMap.enabled = true;
                document.body.appendChild(this.ren.domElement);

                const h = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6); this.scene.add(h);
                const d = new THREE.DirectionalLight(0xffffff, 0.8); d.position.set(10,20,10); d.castShadow=true; this.scene.add(d);

                this.createWorld();
                this.createPlayer();

                const clock = new THREE.Clock();
                const loop = () => {
                    requestAnimationFrame(loop);
                    this.update(Math.min(clock.getDelta(), 0.1));
                    this.ren.render(this.scene, this.cam);
                    TWEEN.update();
                };
                this.menuCam();
                loop();

                window.addEventListener('resize', ()=>{
                    this.cam.aspect=window.innerWidth/window.innerHeight;
                    this.cam.updateProjectionMatrix();
                    this.ren.setSize(window.innerWidth, window.innerHeight);
                });
            },

            createWorld() {
                const g = new THREE.Mesh(new THREE.PlaneGeometry(200,400), new THREE.MeshPhongMaterial({color:0x55efc4}));
                g.rotation.x=-Math.PI/2; g.position.z=-100; g.receiveShadow=true; this.scene.add(g);
                const r = new THREE.Mesh(new THREE.PlaneGeometry(9,400), new THREE.MeshPhongMaterial({color:0xffeaa7}));
                r.rotation.x=-Math.PI/2; r.position.z=-100; r.position.y=0.02; r.receiveShadow=true; this.scene.add(r);
            },

            createPlayer() {
                if(this.player) this.scene.remove(this.player);
                const info = C.chars.find(c=>c.id===Save.data.sel);
                const g = new THREE.Group();
                const mat = new THREE.MeshLambertMaterial({color:info.col});
                const body = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), mat);
                body.position.y=0.5; body.castShadow=true; g.add(body);

                if(info.id==='c1') {
                    const b=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.4), new THREE.MeshLambertMaterial({color:0xf1c40f})); b.position.set(0,0.5,0.6); g.add(b);
                    const c=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.4,0.6), new THREE.MeshLambertMaterial({color:0xe74c3c})); c.position.set(0,1.1,0); g.add(c);
                } else if(info.id==='c3') {
                    const n=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.3,0.1), new THREE.MeshLambertMaterial({color:0xffaaff})); n.position.set(0,0.5,0.6); g.add(n);
                } else {
                    const e=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.6,0.2), mat); e.position.set(-0.3,1.1,0); g.add(e);
                    const e2=e.clone(); e2.position.set(0.3,1.1,0); g.add(e2);
                }
                this.scene.add(g); this.player = g;
            },

            spawn(z) {
                if(!this.active && z > -40) return;
                
                // Decor
                const side = Math.random()>0.5?1:-1;
                const tree = new THREE.Group();
                const t = new THREE.Mesh(new THREE.BoxGeometry(0.4,1,0.4), new THREE.MeshLambertMaterial({color:0x795548})); t.position.y=0.5;
                const l = new THREE.Mesh(new THREE.DodecahedronGeometry(1), new THREE.MeshLambertMaterial({color:0x2ecc71})); l.position.y=1.5;
                tree.add(t,l); tree.position.set(side*(6+Math.random()*4), 0, z);
                this.scene.add(tree); this.objs.push({m:tree, t:'dec'});

                if(!this.active) return;

                const lane = Math.floor(Math.random()*3)-1;
                const x = lane * 2.5;
                if(Math.random()<0.6) {
                    const o = new THREE.Mesh(new THREE.BoxGeometry(2,1,1), new THREE.MeshLambertMaterial({color:0xe74c3c}));
                    o.position.set(x,0.5,z); o.castShadow=true;
                    this.scene.add(o); this.objs.push({m:o, t:'obs', act:true});
                } else {
                    const c = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.1,12), new THREE.MeshPhongMaterial({color:0xffd700}));
                    c.rotation.z=Math.PI/2; c.position.set(x,1,z);
                    this.scene.add(c); this.objs.push({m:c, t:'coin', act:true});
                }
            },

            menuCam() {
                this.cam.position.set(0,5,10); this.cam.lookAt(0,1,-5);
                if(this.player) { this.player.position.set(0,0,0); this.player.rotation.set(0,Math.PI,0); }
            },

            update(dt) {
                const speed = this.active ? this.speed : 5;
                const dz = speed * dt;

                if(this.active) {
                    this.speed += dt * 0.5;
                    this.score += this.speed * dt;
                    this.player.position.x += (this.tx - this.player.position.x) * 15 * dt;
                    this.player.rotation.z = (this.player.position.x - this.tx) * -0.2;
                    this.player.position.y = 0.5 + Math.abs(Math.sin(Date.now()*0.015))*0.2;
                    this.cam.position.x += (this.player.position.x*0.5 - this.cam.position.x) * 5 * dt;
                    document.getElementById('score').innerText = Math.floor(this.score);
                } else {
                    if(this.player) this.player.rotation.y += dt;
                }

                for(let i=this.objs.length-1; i>=0; i--) {
                    let o = this.objs[i];
                    o.m.position.z += dz;

                    if(this.active && o.act && o.m.position.z > -1 && o.m.position.z < 1) {
                        const dx = Math.abs(o.m.position.x - this.player.position.x);
                        if(o.t==='obs' && dx < 0.7) App.over();
                        if(o.t==='coin' && dx < 1.0) {
                            Sfx.coin(); this.coins++; Save.data.coins++;
                            this.scene.remove(o.m); o.act=false;
                            document.getElementById('coins').innerText = this.coins;
                            Save.updateQuest(1);
                        }
                    }
                    if(o.m.position.z > 10) { this.scene.remove(o.m); this.objs.splice(i,1); }
                    if(o.t==='coin') o.m.rotation.x += 0.1;
                }

                if(Math.random()<0.06) this.spawn(-60);
            }
        };

        /* ==================== 4. LOGIC ==================== */
        const App = {
            init() {
                Save.load();
                Game.init();
                UI.render();
                
                // Event listener direct sur le bouton pour Ã©viter les blocages
                document.getElementById('btn-start').addEventListener('click', () => {
                    App.play();
                });
            },

            play() {
                Sfx.init(); Sfx.jump();
                document.getElementById('menu').classList.add('hidden');
                document.getElementById('over').classList.add('hidden');
                document.getElementById('hud').classList.remove('hidden');
                document.getElementById('tuto').classList.remove('hidden'); // Show Tuto

                Game.active = true;
                Game.speed = 15; Game.score = 0; Game.coins = 0; Game.lane = 0; Game.tx = 0;
                Game.player.rotation.set(0,0,0);
                
                new TWEEN.Tween(Game.cam.position).to({x:0, y:4, z:6}, 1000).start();
                
                // Clean
                Game.objs.forEach(o => { if(o.t!=='dec' && o.m.position.z > -20) { Game.scene.remove(o.m); o.act=false; } });
            },

            move(dir) {
                if(!Game.active) return;
                document.getElementById('tuto').classList.add('hidden');
                Game.lane += dir;
                if(Game.lane < -1) Game.lane = -1; if(Game.lane > 1) Game.lane = 1;
                Game.tx = Game.lane * 2.5;
                Sfx.jump();
                new TWEEN.Tween(Game.player.rotation).to({z:-dir*0.3}, 150).yoyo(true).repeat(1).start();
            },

            over() {
                Game.active = false; Sfx.crash(); Save.save();
                document.getElementById('hud').classList.add('hidden');
                document.getElementById('over').classList.remove('hidden');
                document.getElementById('end-score').innerText = Math.floor(Game.score);
                document.getElementById('end-coins').innerText = Game.coins;
            },

            menu() {
                document.getElementById('over').classList.add('hidden');
                document.getElementById('menu').classList.remove('hidden');
                UI.render(); Game.menuCam();
            },

            buy(id) {
                Sfx.init();
                const ch = C.chars.find(c=>c.id===id);
                if(Save.data.unlock.includes(id)) {
                    Save.data.sel = id; Game.createPlayer(); Sfx.jump();
                } else if(Save.data.coins >= ch.price) {
                    Save.data.coins -= ch.price; Save.data.unlock.push(id); Save.data.sel = id;
                    Game.createPlayer(); Sfx.buy(); UI.toast("DÃ‰BLOQUÃ‰ !");
                } else {
                    Sfx.crash(); UI.toast("PAS ASSEZ DE PIÃˆCES");
                }
                Save.save(); UI.render();
            }
        };

        const UI = {
            render() {
                document.getElementById('menu-coins').innerText = Save.data.coins;
                document.getElementById('q-desc').innerText = Save.data.qDone ? "Mission TerminÃ©e !" : `${C.quest.desc} (${Save.data.qVal}/${C.quest.target})`;
                document.getElementById('q-bar').style.width = Math.min(100, (Save.data.qVal/C.quest.target)*100) + '%';

                const list = document.getElementById('shop-list'); list.innerHTML = '';
                C.chars.forEach(c => {
                    const un = Save.data.unlock.includes(c.id);
                    const sel = Save.data.sel === c.id;
                    const d = document.createElement('div');
                    d.className = `char-item pointer ${sel?'selected':''} ${!un?'locked':''}`;
                    d.innerHTML = `<div style="font-size:30px">${c.icon}</div>${!un?`<div class="price">${c.price}</div>`:''}`;
                    d.onclick = (e) => { e.stopPropagation(); App.buy(c.id); };
                    list.appendChild(d);
                });
            },
            toast(m) {
                const t = document.getElementById('toast'); t.innerText=m; t.classList.add('show-toast');
                setTimeout(()=>t.classList.remove('show-toast'), 2000);
            }
        };

        let sx=0;
        document.addEventListener('touchstart', e=>sx=e.changedTouches[0].clientX, {passive:false});
        document.addEventListener('touchend', e=>{ if(Math.abs(e.changedTouches[0].clientX-sx)>30) App.move(e.changedTouches[0].clientX>sx?1:-1); }, {passive:false});
        document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') App.move(-1); if(e.key==='ArrowRight') App.move(1); });

        window.onload = () => App.init();

    </script>
</body>
</html>
