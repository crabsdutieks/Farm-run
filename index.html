<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FARM RUNNER: ULTIMATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Carter+One&family=Roboto:wght@700&display=swap');
        
        body { margin: 0; overflow: hidden; background: #48dbfb; font-family: 'Carter One', cursive; touch-action: none; user-select: none; }

        /* --- UI LAYERS --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; cursor: pointer; }
        .hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }

        /* --- 1. MENU & TITRE --- */
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0) 0%, rgba(0,0,0,0.4) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 50px 0; box-sizing: border-box;
            transition: opacity 0.5s;
        }

        .game-title {
            font-size: 12vw; color: #fff;
            text-shadow: 0 10px 0 #2980b9, 0 15px 20px rgba(0,0,0,0.4);
            margin: 0; text-transform: uppercase; letter-spacing: 2px;
            transform: rotate(-3deg);
            animation: float 3s ease-in-out infinite;
        }
        @media (min-width: 600px) { .game-title { font-size: 80px; } }

        @keyframes float { 0%, 100% { transform: rotate(-3deg) translateY(0); } 50% { transform: rotate(-3deg) translateY(-15px); } }

        .char-selector {
            display: flex; gap: 20px; background: rgba(255,255,255,0.2);
            padding: 10px; border-radius: 20px; backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.5);
        }
        .char-btn {
            background: transparent; border: none; color: white;
            padding: 10px 20px; font-family: 'Carter One'; font-size: 20px;
            border-radius: 15px; transition: 0.2s; opacity: 0.7;
        }
        .char-btn.selected {
            background: white; color: #333; opacity: 1; transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .play-btn {
            background: linear-gradient(to bottom, #f1c40f, #f39c12);
            border: none; border-bottom: 8px solid #d35400;
            color: white; font-size: 35px; padding: 15px 80px; border-radius: 50px;
            font-family: 'Carter One'; text-transform: uppercase;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.1s; margin-bottom: 20px;
        }
        .play-btn:active { transform: translateY(4px); border-bottom-width: 4px; }

        /* --- 2. HUD JEU --- */
        #game-hud {
            position: absolute; top: 0; width: 100%; padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; opacity: 0; transition: opacity 0.5s;
        }
        .stat-pill {
            background: white; padding: 8px 20px; border-radius: 30px;
            font-size: 24px; color: #333; border: 3px solid #333;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px;
        }

        /* --- 3. GAME OVER --- */
        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(192, 57, 43, 0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .go-text { font-size: 60px; color: white; margin-bottom: 20px; text-shadow: 0 5px 0 rgba(0,0,0,0.3); }

        /* Flash Effect */
        #flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.2s;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="flash"></div>

    <div id="ui-layer">
        <div id="menu-screen">
            <h1 class="game-title">FARM<br>RUNNER</h1>
            
            <div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-bottom: 50px;">
                <div class="char-selector interactive">
                    <button class="char-btn selected" id="btn-c" onclick="selectChar('chicken')">POULET</button>
                    <button class="char-btn" id="btn-r" onclick="selectChar('rabbit')">LAPIN</button>
                </div>
                <button class="play-btn interactive" onclick="startGame()">JOUER</button>
                <div style="color:white; font-size:14px; opacity:0.8;">MEILLEUR: <span id="best-score">0</span></div>
            </div>
        </div>

        <div id="game-hud">
            <div class="stat-pill">SCORE <span id="score">0</span></div>
            <div class="stat-pill" style="color:#f39c12;">ðŸª™ <span id="coins">0</span></div>
        </div>

        <div id="game-over" class="interactive">
            <div class="go-text">CRASH !</div>
            <div class="stat-pill" style="margin-bottom:20px;">TOTAL: <span id="final-score">0</span></div>
            <button class="play-btn" onclick="backToMenu()">MENU</button>
        </div>
    </div>

    <script>
        // ================= AUDIO (SYNTH) =================
        const AudioSys = {
            ctx: null,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)();
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(f, type, dur, vol=0.1) {
                if(!this.ctx) return;
                const t=this.ctx.currentTime;
                const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                o.type=type; 
                if(Array.isArray(f)){
                    o.frequency.setValueAtTime(f[0], t);
                    o.frequency.linearRampToValueAtTime(f[1], t+dur);
                } else { o.frequency.setValueAtTime(f, t); }
                g.gain.setValueAtTime(vol, t);
                g.gain.exponentialRampToValueAtTime(0.01, t+dur);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(t+dur);
            },
            swoosh: function() { this.play([200, 600], 'sine', 0.3, 0.1); },
            coin: function() { this.play([1200, 1800], 'square', 0.1, 0.1); },
            crash: function() { this.play([150, 50], 'sawtooth', 0.5, 0.3); },
            start: function() { this.play([400, 800], 'triangle', 0.4, 0.2); }
        };

        // ================= GLOBALS =================
        let scene, camera, renderer, clock;
        let state = 'INTRO'; // INTRO, MENU, PLAY, GAMEOVER
        let player;
        let obstacles=[], coins=[], decors=[];
        
        // Game params
        let speed=0, score=0, coinCount=0;
        let lane=0, targetX=0;
        const LANE_SIZE = 2.5;
        let charType = 'chicken';
        let highScore = localStorage.getItem('fr_best') || 0;
        document.getElementById('best-score').innerText = highScore;

        window.onload = init;

        function init() {
            // 1. Setup 3D
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x48dbfb);
            scene.fog = new THREE.Fog(0x48dbfb, 15, 60);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // LumiÃ¨res
            const hemi = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6);
            scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(10, 20, 10);
            dir.castShadow = true;
            scene.add(dir);

            // Monde
            createWorld();
            createPlayer('chicken');

            // Events (Input Robustesse)
            document.addEventListener('keydown', onKey);
            document.addEventListener('touchstart', onTouchStart, {passive:false});
            document.addEventListener('touchend', onTouchEnd, {passive:false});
            window.addEventListener('resize', onResize);
            // Activer le son au premier clic n'importe oÃ¹
            document.addEventListener('click', () => AudioSys.init(), {once:true});

            clock = new THREE.Clock();
            
            // Lancer l'intro cinÃ©matique
            startIntro();
            
            animate();
        }

        // ================= 3D BUILDER =================
        function createWorld() {
            const gGeo = new THREE.PlaneGeometry(100, 400);
            const gMat = new THREE.MeshPhongMaterial({color:0x55efc4}); // Vert menthe vibrant
            const ground = new THREE.Mesh(gGeo, gMat);
            ground.rotation.x = -Math.PI/2;
            ground.position.z = -100;
            ground.receiveShadow = true;
            scene.add(ground);

            const rGeo = new THREE.PlaneGeometry(8, 400);
            const rMat = new THREE.MeshPhongMaterial({color:0xffeaa7}); // Sable jaune
            const road = new THREE.Mesh(rGeo, rMat);
            road.rotation.x = -Math.PI/2;
            road.position.set(0, 0.02, -100);
            road.receiveShadow = true;
            scene.add(road);
        }

        function createPlayer(type) {
            if(player) scene.remove(player);
            const g = new THREE.Group();

            const matW = new THREE.MeshLambertMaterial({color:0xffffff});
            const matG = new THREE.MeshLambertMaterial({color:0xb2bec3});
            const base = type==='chicken'?matW:matG;

            // Corps "Voxel"
            const body = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), base);
            body.position.y = 0.5;
            body.castShadow = true;
            g.add(body);

            if(type==='chicken') {
                const beak = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.4), new THREE.MeshLambertMaterial({color:0xf1c40f}));
                beak.position.set(0, 0.5, 0.6);
                const comb = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.4,0.5), new THREE.MeshLambertMaterial({color:0xe74c3c}));
                comb.position.set(0, 1.1, 0);
                g.add(beak, comb);
            } else {
                const e1 = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.6,0.2), base); e1.position.set(-0.3,1.1,0);
                const e2 = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.6,0.2), base); e2.position.set(0.3,1.1,0);
                g.add(e1,e2);
            }
            scene.add(g);
            player = g;
        }

        function spawnObject(z) {
            // DÃ©cors (Arbres pop)
            const side = Math.random()>0.5?1:-1;
            const tree = new THREE.Group();
            const t1 = new THREE.Mesh(new THREE.BoxGeometry(0.6,1,0.6), new THREE.MeshLambertMaterial({color:0x8B4513}));
            t1.position.y = 0.5;
            const t2 = new THREE.Mesh(new THREE.BoxGeometry(1.5,1.5,1.5), new THREE.MeshLambertMaterial({color:0x00b894}));
            t2.position.y = 1.5;
            tree.add(t1,t2);
            tree.position.set(side*(5+Math.random()*5), 0, z);
            // Animation de "Pop"
            tree.scale.set(0,0,0);
            new TWEEN.Tween(tree.scale).to({x:1,y:1,z:1}, 400).easing(TWEEN.Easing.Elastic.Out).start();
            
            scene.add(tree);
            decors.push(tree);

            if(z > -20 && state !== 'PLAY') return; 
            if(state === 'INTRO') return;

            // Logic Gameplay
            const laneIdx = Math.floor(Math.random()*3)-1;
            const x = laneIdx * LANE_SIZE;

            // Obstacle (Haute proba pour challenge)
            if(Math.random() < 0.6) {
                let mesh;
                if(Math.random()<0.5) {
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(1.5,1.2,1.5), new THREE.MeshLambertMaterial({color:0xf1c40f}));
                    mesh.position.set(x, 0.6, z);
                } else {
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.8,0.2), new THREE.MeshLambertMaterial({color:0xe74c3c}));
                    mesh.position.set(x, 0.4, z);
                }
                mesh.castShadow = true;
                scene.add(mesh);
                obstacles.push(mesh);
            }

            // PiÃ¨ce (Moins de piÃ¨ces = plus prÃ©cieuses)
            if(Math.random() < 0.3) {
                const cLane = (laneIdx+1 > 1) ? -1 : laneIdx+1;
                const coin = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.1,12), new THREE.MeshPhongMaterial({color:0xFFD700}));
                coin.rotation.z = Math.PI/2;
                coin.position.set(cLane * LANE_SIZE, 1, z);
                scene.add(coin);
                coins.push(coin);
            }
        }

        // ================= ETAT & LOGIQUE =================

        function startIntro() {
            state = 'INTRO';
            // La camÃ©ra dÃ©marre haut et loin
            camera.position.set(0, 8, 15);
            camera.lookAt(0, 0, -10);
            
            // Transition fluide vers le Menu
            new TWEEN.Tween(camera.position)
                .to({x:0, y:3, z:5}, 2500)
                .easing(TWEEN.Easing.Cubic.Out)
                .onComplete(() => {
                    state = 'MENU';
                    // On s'assure que le joueur regarde la camÃ©ra
                    if(player) player.rotation.set(0, Math.PI, 0);
                })
                .start();
            
            // Remplir le monde
            for(let i=1; i<20; i++) spawnObject(-i*10);
        }

        function selectChar(type) {
            AudioSys.init();
            charType = type;
            createPlayer(type);
            document.getElementById('btn-c').classList.toggle('selected', type==='chicken');
            document.getElementById('btn-r').classList.toggle('selected', type==='rabbit');
            
            // Petit saut de joie
            if(player) {
                player.rotation.set(0, Math.PI, 0);
                new TWEEN.Tween(player.position).to({y:1.5}, 200).yoyo(true).repeat(1).start();
            }
            AudioSys.swoosh();
        }

        function startGame() {
            AudioSys.init();
            AudioSys.start();

            // Flash blanc
            const f = document.getElementById('flash');
            f.style.opacity = 0.8;
            setTimeout(() => f.style.opacity = 0, 300);

            // UI Switch
            document.getElementById('menu-screen').style.opacity = 0;
            document.getElementById('menu-screen').style.pointerEvents = 'none';
            document.getElementById('game-hud').style.opacity = 1;
            document.getElementById('game-over').style.opacity = 0;
            document.getElementById('game-over').style.pointerEvents = 'none';

            state = 'PLAY';
            score=0; coinCount=0; speed=15; lane=0; targetX=0;
            
            // Reset Scene
            obstacles.forEach(o=>scene.remove(o)); obstacles=[];
            coins.forEach(c=>scene.remove(c)); coins=[];
            // On garde les dÃ©cors pour la continuitÃ©
            
            // Perso dos camÃ©ra
            player.rotation.set(0,0,0);
            player.position.set(0,0,0);

            // Camera Game pos
            new TWEEN.Tween(camera.position).to({x:0, y:4, z:7}, 1000).start();
            new TWEEN.Tween(camera.fov).to(60, 1000).onUpdate(()=>camera.updateProjectionMatrix()).start();
        }

        function backToMenu() {
            document.getElementById('game-over').style.opacity = 0;
            document.getElementById('game-over').style.pointerEvents = 'none';
            document.getElementById('menu-screen').style.opacity = 1;
            document.getElementById('menu-screen').style.pointerEvents = 'auto';
            document.getElementById('game-hud').style.opacity = 0;
            
            state = 'MENU';
            camera.position.set(0,3,5);
            camera.lookAt(0,0.5,0);
            player.position.set(0,0,0);
            player.rotation.set(0,Math.PI,0);
        }

        function gameOver() {
            state = 'GAMEOVER';
            AudioSys.crash();
            
            // Update Score
            const total = Math.floor(score + coinCount * 50);
            if(total > highScore) {
                highScore = total;
                localStorage.setItem('fr_best', highScore);
                document.getElementById('best-score').innerText = highScore;
            }
            document.getElementById('final-score').innerText = total;

            // UI
            document.getElementById('game-hud').style.opacity = 0;
            document.getElementById('game-over').style.opacity = 1;
            document.getElementById('game-over').style.pointerEvents = 'auto';
        }

        // ================= LOOP =================
        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);
            const dt = Math.min(clock.getDelta(), 0.1);
            const t = clock.elapsedTime;

            if(state === 'MENU') {
                // Animation idle menu
                if(player) player.rotation.y = Math.sin(t)*0.3 + Math.PI;
                // DÃ©filement doux du fond
                decors.forEach(d => {
                    d.position.z += 2 * dt;
                    if(d.position.z > 5) d.position.z -= 60;
                });
            }

            else if(state === 'PLAY') {
                // Vitesse explosive (AccÃ©lÃ©ration constante)
                speed += dt * 0.8; // AccÃ©lÃ©ration plus forte
                score += speed * dt;

                // FOV EFFECT (Warp Speed)
                // Plus on va vite, plus le FOV augmente (max 90)
                const targetFOV = Math.min(90, 60 + (speed * 0.5));
                camera.fov += (targetFOV - camera.fov) * dt;
                camera.updateProjectionMatrix();

                // Player Move
                player.position.x += (targetX - player.position.x) * 15 * dt;
                player.rotation.z = (player.position.x - targetX) * -0.15;
                player.position.y = 0.5 + Math.abs(Math.sin(t*speed*0.6))*0.3;

                // Camera Shake lÃ©ger Ã  haute vitesse
                const shake = Math.max(0, (speed-30)*0.002);
                camera.position.x += (player.position.x * 0.5 - camera.position.x) * 5 * dt + (Math.random()-0.5)*shake;

                // World Move
                const moveZ = speed * dt;
                
                // Obstacles
                for(let i=obstacles.length-1; i>=0; i--) {
                    let o = obstacles[i];
                    o.position.z += moveZ;
                    // Collision
                    if(o.position.z > -1 && o.position.z < 1) {
                        if(Math.abs(o.position.x - player.position.x) < 0.8) gameOver();
                    }
                    if(o.position.z > 10) { scene.remove(o); obstacles.splice(i,1); }
                }

                // Coins
                for(let i=coins.length-1; i>=0; i--) {
                    let c = coins[i];
                    c.position.z += moveZ;
                    c.rotation.y += 0.1;
                    if(c.position.z > -1 && c.position.z < 1) {
                        if(Math.abs(c.position.x - player.position.x) < 1.0) {
                            AudioSys.coin();
                            coinCount++;
                            scene.remove(c);
                            coins.splice(i,1);
                            
                            // FX visuel piÃ¨ce (scale up and fade)
                            // SimplifiÃ© pour perf: juste remove
                        }
                    }
                    if(c.position.z > 10) { scene.remove(c); coins.splice(i,1); }
                }

                // Decors
                for(let i=decors.length-1; i>=0; i--) {
                    decors[i].position.z += moveZ;
                    if(decors[i].position.z > 10) { scene.remove(decors[i]); decors.splice(i,1); }
                }

                // Spawn infini
                if(Math.random() < 0.05) spawnObject(-60); // Spawn un peu plus loin pour Ã©viter pop visible

                // Update UI
                document.getElementById('score').innerText = Math.floor(score);
                document.getElementById('coins').innerText = coinCount;
            }

            renderer.render(scene, camera);
        }

        // ================= INPUTS (ROBUSTES) =================
        function moveLane(dir) {
            if(state !== 'PLAY') return;
            lane += dir;
            if(lane < -1) lane = -1;
            if(lane > 1) lane = 1;
            targetX = lane * LANE_SIZE;
            AudioSys.swoosh();
        }

        function onKey(e) {
            if(e.key === 'ArrowLeft' || e.key === 'q') moveLane(-1);
            if(e.key === 'ArrowRight' || e.key === 'd') moveLane(1);
        }

        let ts = 0;
        function onTouchStart(e) { ts = e.changedTouches[0].clientX; }
        function onTouchEnd(e) {
            let te = e.changedTouches[0].clientX;
            if(Math.abs(te - ts) > 30) {
                if(te > ts) moveLane(1);
                else moveLane(-1);
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
